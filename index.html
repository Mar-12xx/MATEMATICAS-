<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Malla Matemática Interactiva</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }

    #canvas-container {
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }

    svg {
      width: 2000px;
      height: 1600px;
    }

    .node rect, .node ellipse {
      fill: white;
      stroke: #666;
      stroke-width: 2px;
      rx: 10;
      ry: 10;
      cursor: pointer;
    }

    .node.approved rect, .node.approved ellipse {
      fill: #c8f7c5;
      stroke: #2ecc71;
    }

    .node.locked rect, .node.locked ellipse {
      fill: #ddd;
      stroke: #aaa;
      cursor: not-allowed;
    }

    .node text {
      pointer-events: none;
      font-size: 14px;
      fill: #333;
    }

    .arrow {
      stroke: #333;
      stroke-width: 1.5;
      marker-end: url(#arrowhead);
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <svg id="graph" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" />
        </marker>
      </defs>
      <!-- Aquí se insertarán dinámicamente los nodos y flechas -->
    </svg>
  </div>

  <script>
    const topics = [
      {
        id: "numeros",
        label: "Números",
        shape: "circle",
        x: 50,
        y: 50,
        dependsOn: []
      },
      {
        id: "operaciones",
        label: "Operaciones y Propiedades",
        shape: "rect",
        x: 200,
        y: 50,
        dependsOn: ["numeros"]
      },
      {
        id: "divisibilidad",
        label: "Divisibilidad y Múltiplos",
        shape: "rect",
        x: 400,
        y: 50,
        dependsOn: ["operaciones"]
      },
      {
        id: "mcm",
        label: "MCD y MCM",
        shape: "rect",
        x: 600,
        y: 50,
        dependsOn: ["divisibilidad"]
      }
    ];

    const svg = document.getElementById("graph");
    const approved = JSON.parse(localStorage.getItem("math-progress") || "[]");

    function drawNode(topic) {
      const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
      g.setAttribute("class", "node");
      g.setAttribute("id", topic.id);
      g.setAttribute("transform", `translate(${topic.x}, ${topic.y})`);

      const labelLength = topic.label.length * 7 + 10;
      const width = Math.max(80, labelLength);
      const height = 35;

      let shape;
      if (topic.shape === "circle") {
        shape = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
        shape.setAttribute("cx", width / 2);
        shape.setAttribute("cy", height / 2);
        shape.setAttribute("rx", width / 2);
        shape.setAttribute("ry", height / 2);
      } else {
        shape = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        shape.setAttribute("width", width);
        shape.setAttribute("height", height);
      }

      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", width / 2);
      text.setAttribute("y", height / 2 + 5);
      text.setAttribute("text-anchor", "middle");
      text.textContent = topic.label;

      g.appendChild(shape);
      g.appendChild(text);
      svg.appendChild(g);

      const isApproved = approved.includes(topic.id);
      const locked = topic.dependsOn.some(dep => !approved.includes(dep));
      g.classList.add(isApproved ? "approved" : locked ? "locked" : "");

      if (!locked) {
        g.addEventListener("click", () => {
          const index = approved.indexOf(topic.id);
          if (index === -1) {
            approved.push(topic.id);
          } else {
            approved.splice(index, 1);
          }
          localStorage.setItem("math-progress", JSON.stringify(approved));
          location.reload();
        });
      } else {
        g.setAttribute("title", "Debes aprobar los temas anteriores primero");
      }

      topic.width = width;
      topic.height = height;
    }

    function drawArrow(fromId, toId) {
      const from = topics.find(t => t.id === fromId);
      const to = topics.find(t => t.id === toId);

      const x1 = from.x + from.width / 2;
      const y1 = from.y + from.height;
      const x2 = to.x + to.width / 2;
      const y2 = to.y;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("class", "arrow");
      svg.appendChild(line);
    }

    topics.forEach(drawNode);
    topics.forEach(topic => {
      topic.dependsOn.forEach(dep => drawArrow(dep, topic.id));
    });
  </script>
</body>
</html>
