<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Curricular de Ingenier√≠a</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to override or enhance Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .curriculum-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px; /* Max width for the entire map */
            min-height: 1500px; /* Adjust based on content height */
            margin-top: 20px;
            margin-bottom: 50px;
        }

        .unit {
            position: absolute;
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.2;
            width: 120px; /* Fixed width for units */
            height: 60px; /* Fixed height for units */
            z-index: 10; /* Ensure units are above SVG lines */
        }

        .unit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .unit.approved {
            background-color: #d1fae5; /* Green-100 */
            border-color: #34d399; /* Green-400 */
            color: #065f46; /* Green-800 */
        }

        .unit.locked {
            background-color: #f3f4f6; /* Gray-100 */
            border-color: #cbd5e1; /* Gray-300 */
            color: #6b7280; /* Gray-500 */
            cursor: not-allowed;
        }

        .unit-title {
            font-weight: 600; /* semibold */
            margin-bottom: 0.25rem;
        }

        .unit-status {
            font-size: 0.8rem;
            color: #9ca3af; /* Gray-400 */
        }

        .unit.approved .unit-status {
            color: #065f46; /* Green-800 */
        }

        .unit.locked .unit-status {
            color: #9ca3af; /* Gray-400 */
        }

        .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.3rem 0.6rem;
            position: absolute;
            z-index: 20; /* Above units */
            bottom: 110%; /* Position above the unit */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .unit.locked:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .clear-progress-btn {
            @apply bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300;
        }

        /* SVG styles for arrows */
        .arrow-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through to units */
            z-index: 5; /* Below units */
        }

        .arrow-line {
            stroke: #6b7280; /* Gray-500 */
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead); /* Use defined arrowhead */
        }

        .arrow-line.approved-path {
            stroke: #10b981; /* Green-500 for approved paths */
        }

        /* Styles for sections (An√°lisis, √Ålgebra, Geometr√≠a, Aritm√©tica) */
        .section-label {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            z-index: 15; /* Above units and arrows */
            background-color: #f0f2f5; /* Match body background */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        /* Specific positioning for section labels based on the map */
        #analisis-label { top: 10%; left: 30%; color: #ef4444; /* Red */ }
        #algebra-label { top: 50%; left: 55%; color: #3b82f6; /* Blue */ }
        #geometria-label { top: 65%; left: 75%; color: #22c55e; /* Green */ }
        #aritmetica-label { top: 75%; left: 20%; color: #6b7280; /* Gray */ }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .unit {
                width: 100px;
                height: 50px;
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
            }
            .unit-title {
                font-size: 0.9rem;
            }
            .unit-status {
                font-size: 0.7rem;
            }
            .section-label {
                font-size: 1.2rem;
            }
            .curriculum-wrapper {
                min-height: 2000px; /* Increase height for smaller screens */
            }
        }

        /* Modal Styles */
        #llmModalOverlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        #llmModalContent {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Gu√≠a Propuesta para Estudiar Temas de Matem√°tica para Carreras de Ingenier√≠a</h1>
    <div class="flex flex-wrap justify-center gap-4 mb-6">
        <button id="clearProgressBtn" class="clear-progress-btn">Borrar Progreso</button>
        <button id="suggestNextStepsBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">
            ‚ú® Sugerir Siguientes Pasos
        </button>
    </div>


    <div id="curriculumWrapper" class="curriculum-wrapper">
        <!-- SVG for drawing arrows -->
        <svg class="arrow-svg" id="arrowSvg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                </marker>
                <marker id="arrowhead-approved" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                </marker>
            </defs>
            <!-- Arrows will be drawn here by JavaScript -->
        </svg>

        <!-- Section Labels -->
        <div id="analisis-label" class="section-label">AN√ÅLISIS</div>
        <div id="algebra-label" class="section-label">√ÅLGEBRA</div>
        <div id="geometria-label" class="section-label">GEOMETR√çA</div>
        <div id="aritmetica-label" class="section-label">ARITM√âTICA</div>

        <!-- Units will be injected here by JavaScript -->
    </div>

    <!-- LLM Modal Structure -->
    <div id="llmModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="llmModalContent" class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-11/12 max-h-[80vh] overflow-y-auto relative">
            <h3 class="text-xl font-bold mb-4"></h3>
            <div id="llmModalBody" class="text-gray-700 mb-4"></div>
            <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal()">
                &times;
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const curriculumWrapper = document.getElementById('curriculumWrapper');
            const arrowSvg = document.getElementById('arrowSvg');
            const clearProgressBtn = document.getElementById('clearProgressBtn');
            const suggestNextStepsBtn = document.getElementById('suggestNextStepsBtn');

            // Modal elements
            const llmModalOverlay = document.getElementById('llmModalOverlay');
            const llmModalContent = document.getElementById('llmModalContent');
            const llmModalTitle = llmModalContent.querySelector('h3');
            const llmModalBody = document.getElementById('llmModalBody');

            let approvedUnits = JSON.parse(localStorage.getItem('approvedUnits')) || [];

            // Define all units with their properties (id, name, dependencies, position, color hint for sections)
            // Positions (x, y) are relative percentages within the curriculumWrapper
            // Width and height are fixed in CSS, but included here for arrow calculation
            const unitsData = [
                // ARITM√âTICA
                { id: 'introduccion_aritmetica', name: 'Introducci√≥n a la Aritm√©tica', dependencies: [], x: 15, y: 75, section: 'aritmetica' },
                { id: 'numeros_reales', name: 'N√∫meros Reales', dependencies: ['introduccion_aritmetica'], x: 15, y: 65, section: 'aritmetica' },
                { id: 'operaciones_basicas', name: 'Operaciones B√°sicas', dependencies: ['introduccion_aritmetica'], x: 30, y: 65, section: 'aritmetica' },
                { id: 'potenciacion_radicacion', name: 'Potenciaci√≥n y Radicaci√≥n', dependencies: ['operaciones_basicas'], x: 30, y: 55, section: 'aritmetica' },
                { id: 'logaritmos', name: 'Logaritmos', dependencies: ['potenciacion_radicacion'], x: 30, y: 45, section: 'aritmetica' },

                // √ÅLGEBRA
                { id: 'introduccion_algebra', name: 'Introducci√≥n al √Ålgebra', dependencies: ['numeros_reales', 'operaciones_basicas'], x: 45, y: 55, section: 'algebra' },
                { id: 'expresiones_algebraicas', name: 'Expresiones Algebraicas', dependencies: ['introduccion_algebra'], x: 45, y: 45, section: 'algebra' },
                { id: 'polinomios', name: 'Polinomios', dependencies: ['expresiones_algebraicas'], x: 45, y: 35, section: 'algebra' },
                { id: 'ecuaciones_lineales', name: 'Ecuaciones Lineales', dependencies: ['polinomios'], x: 45, y: 25, section: 'algebra' },
                { id: 'sistemas_ecuaciones', name: 'Sistemas de Ecuaciones', dependencies: ['ecuaciones_lineales'], x: 60, y: 25, section: 'algebra' },
                { id: 'matrices_determinantes', name: 'Matrices y Determinantes', dependencies: ['sistemas_ecuaciones'], x: 60, y: 15, section: 'algebra' },
                { id: 'vectores', name: 'Vectores', dependencies: ['matrices_determinantes'], x: 75, y: 15, section: 'algebra' },

                // AN√ÅLISIS
                { id: 'funciones', name: 'Funciones', dependencies: ['ecuaciones_lineales'], x: 30, y: 25, section: 'analisis' },
                { id: 'limites', name: 'L√≠mites', dependencies: ['funciones'], x: 30, y: 15, section: 'analisis' },
                { id: 'derivadas', name: 'Derivadas', dependencies: ['limites'], x: 15, y: 15, section: 'analisis' },
                { id: 'integrales', name: 'Integrales', dependencies: ['derivadas'], x: 15, y: 5, section: 'analisis' },
                { id: 'series_sucesiones', name: 'Series y Sucesiones', dependencies: ['integrales'], x: 30, y: 5, section: 'analisis' },
                { id: 'ecuaciones_diferenciales', name: 'Ecuaciones Diferenciales', dependencies: ['integrales', 'series_sucesiones'], x: 45, y: 5, section: 'analisis' },

                // GEOMETR√çA
                { id: 'introduccion_geometria', name: 'Introducci√≥n a la Geometr√≠a', dependencies: ['numeros_reales'], x: 75, y: 65, section: 'geometria' },
                { id: 'geometria_plana', name: 'Geometr√≠a Plana', dependencies: ['introduccion_geometria'], x: 75, y: 55, section: 'geometria' },
                { id: 'geometria_espacial', name: 'Geometr√≠a Espacial', dependencies: ['geometria_plana'], x: 75, y: 45, section: 'geometria' },
                { id: 'geometria_analitica', name: 'Geometr√≠a Anal√≠tica', dependencies: ['geometria_espacial', 'vectores'], x: 75, y: 35, section: 'geometria' },
                { id: 'transformaciones_geometricas', name: 'Transformaciones Geom√©tricas', dependencies: ['geometria_analitica'], x: 75, y: 25, section: 'geometria' },
                { id: 'calculo_vectorial', name: 'C√°lculo Vectorial', dependencies: ['vectores', 'derivadas', 'integrales'], x: 60, y: 5, section: 'geometria' },
                { id: 'topologia', name: 'Topolog√≠a', dependencies: ['calculo_vectorial'], x: 75, y: 5, section: 'geometria' },

                // Connections between sections
                { id: 'matematicas_discretas', name: 'Matem√°ticas Discretas', dependencies: ['logaritmos', 'polinomios'], x: 60, y: 45, section: 'algebra' },
                { id: 'probabilidad_estadistica', name: 'Probabilidad y Estad√≠stica', dependencies: ['logaritmos', 'sistemas_ecuaciones'], x: 60, y: 35, section: 'algebra' },
            ];

            // Map unit IDs to their data objects for easy lookup
            const unitsMap = new Map(unitsData.map(unit => [unit.id, unit]));

            function saveProgress() {
                localStorage.setItem('approvedUnits', JSON.stringify(approvedUnits));
            }

            function isUnitApproved(unitId) {
                return approvedUnits.includes(unitId);
            }

            function getMissingDependencies(unitId) {
                const unit = unitsMap.get(unitId);
                if (!unit) return [];
                return unit.dependencies.filter(depId => !isUnitApproved(depId));
            }

            function openModal(title, content) {
                llmModalTitle.textContent = title;
                llmModalBody.innerHTML = content;
                llmModalOverlay.classList.remove('hidden');
            }

            function closeModal() {
                llmModalOverlay.classList.add('hidden');
            }

            // Make closeModal globally accessible (for the button in the modal)
            window.closeModal = closeModal;

            async function generateSummary(unitId) {
                const unitName = unitsMap.get(unitId)?.name || unitId;
                openModal(`Generando Resumen para "${unitName}"...`, '<p class="text-center">Cargando... ‚ú®</p>');

                try {
                    const prompt = `Genera un resumen conciso y educativo sobre el tema "${unitName}" de matem√°ticas para estudiantes de ingenier√≠a. Enf√≥cate en los conceptos clave y su relevancia.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmModalBody.innerHTML = `<p>${text}</p>`;
                        llmModalTitle.textContent = `Resumen de "${unitName}"`;
                    } else {
                        llmModalBody.innerHTML = '<p class="text-red-500">Error: No se pudo generar el resumen. Int√©ntalo de nuevo.</p>';
                    }
                } catch (error) {
                    console.error('Error al llamar a la API de Gemini:', error);
                    llmModalBody.innerHTML = '<p class="text-red-500">Error de conexi√≥n o del servidor. Int√©ntalo de nuevo.</p>';
                }
            }

            async function suggestNextSteps() {
                openModal('Generando Sugerencias de Estudio...', '<p class="text-center">Cargando... ‚ú®</p>');

                try {
                    const approvedUnitNames = approvedUnits.map(id => unitsMap.get(id)?.name).filter(Boolean);
                    let prompt;
                    if (approvedUnitNames.length > 0) {
                        prompt = `Basado en los siguientes temas de matem√°ticas ya aprobados por un estudiante de ingenier√≠a: ${approvedUnitNames.join(', ')}. Sugiere los 3 a 5 siguientes pasos l√≥gicos en su ruta de estudio. S√© conciso y menciona por qu√© cada sugerencia es relevante.`;
                    } else {
                        prompt = `Un estudiante de ingenier√≠a acaba de empezar su malla curricular de matem√°ticas. Sugiere los 3 a 5 primeros temas fundamentales para comenzar, explicando brevemente por qu√© son importantes.`;
                    }

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmModalBody.innerHTML = `<p>${text}</p>`;
                        llmModalTitle.textContent = `Sugerencias de Estudio ‚ú®`;
                    } else {
                        llmModalBody.innerHTML = '<p class="text-red-500">Error: No se pudieron generar sugerencias. Int√©ntalo de nuevo.</p>';
                    }
                } catch (error) {
                    console.error('Error al llamar a la API de Gemini:', error);
                    llmModalBody.innerHTML = '<p class="text-red-500">Error de conexi√≥n o del servidor. Int√©ntalo de nuevo.</p>';
                }
            }


            function updateUnitStates() {
                document.querySelectorAll('.unit').forEach(unitElement => {
                    const unitId = unitElement.dataset.id;
                    const missingDeps = getMissingDependencies(unitId);
                    const tooltipSpan = unitElement.querySelector('.tooltip');
                    const summaryBtn = unitElement.querySelector('.generate-summary-btn');

                    if (isUnitApproved(unitId)) {
                        unitElement.classList.add('approved');
                        unitElement.classList.remove('locked');
                        unitElement.querySelector('.unit-status').textContent = 'Aprobado ‚úÖ';
                        if (tooltipSpan) tooltipSpan.textContent = ''; // Clear tooltip for approved
                        if (summaryBtn) summaryBtn.classList.remove('hidden'); // Show summary button
                    } else if (missingDeps.length === 0) {
                        unitElement.classList.remove('locked');
                        unitElement.classList.remove('approved');
                        unitElement.querySelector('.unit-status').textContent = 'Click para aprobar';
                        unitElement.style.cursor = 'pointer';
                        if (tooltipSpan) tooltipSpan.textContent = ''; // Clear tooltip for unlockable
                        if (summaryBtn) summaryBtn.classList.add('hidden'); // Hide summary button
                    } else {
                        unitElement.classList.add('locked');
                        unitElement.classList.remove('approved');
                        unitElement.querySelector('.unit-status').textContent = 'Bloqueado üîí';
                        unitElement.style.cursor = 'not-allowed';
                        if (tooltipSpan) {
                            const missingNames = missingDeps.map(depId => unitsMap.get(depId)?.name || depId).join(', ');
                            tooltipSpan.textContent = `Falta(n): ${missingNames}`;
                        }
                        if (summaryBtn) summaryBtn.classList.add('hidden'); // Hide summary button
                    }
                });
                drawArrows(); // Redraw arrows after state changes
            }

            function handleUnitClick(event) {
                const unitElement = event.currentTarget;
                const unitId = unitElement.dataset.id;

                // Check if the click originated from the summary button
                if (event.target.classList.contains('generate-summary-btn')) {
                    // This click is handled by the summary button's own listener
                    return;
                }

                if (unitElement.classList.contains('locked')) {
                    // Unit is locked, do nothing (tooltip will show)
                    return;
                }

                if (isUnitApproved(unitId)) {
                    // If already approved, unapprove it (toggle functionality)
                    approvedUnits = approvedUnits.filter(id => id !== unitId);
                } else {
                    // If not approved and dependencies are met, approve it
                    approvedUnits.push(unitId);
                }
                saveProgress();
                updateUnitStates();
            }

            function renderUnits() {
                unitsData.forEach(unit => {
                    const unitElement = document.createElement('div');
                    unitElement.classList.add('unit');
                    unitElement.dataset.id = unit.id;
                    unitElement.style.left = `${unit.x}%`;
                    unitElement.style.top = `${unit.y}%`;

                    unitElement.innerHTML = `
                        <div class="unit-title">${unit.name}</div>
                        <div class="unit-status"></div>
                        <span class="tooltip"></span>
                        <button class="generate-summary-btn mt-2 bg-purple-500 hover:bg-purple-600 text-white text-xs py-1 px-2 rounded-md hidden">
                            ‚ú® Resumen
                        </button>
                    `;
                    unitElement.addEventListener('click', handleUnitClick);
                    curriculumWrapper.appendChild(unitElement);

                    // Add event listener for the summary button
                    const summaryBtn = unitElement.querySelector('.generate-summary-btn');
                    summaryBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent unit click event from firing
                        generateSummary(unit.id);
                    });
                });
            }

            function getUnitCenter(unitId) {
                const unitElement = document.querySelector(`.unit[data-id="${unitId}"]`);
                if (!unitElement) return null;

                const rect = unitElement.getBoundingClientRect();
                const wrapperRect = curriculumWrapper.getBoundingClientRect();

                // Calculate center relative to the wrapper
                const centerX = (rect.left + rect.right) / 2 - wrapperRect.left;
                const centerY = (rect.top + rect.bottom) / 2 - wrapperRect.top;

                return { x: centerX, y: centerY };
            }

            function drawArrows() {
                arrowSvg.innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                        </marker>
                        <marker id="arrowhead-approved" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                        </marker>
                    </defs>
                `; // Clear existing arrows and re-add markers

                unitsData.forEach(unit => {
                    const fromUnit = unit;
                    const fromCenter = getUnitCenter(fromUnit.id);

                    if (!fromCenter) return;

                    fromUnit.dependencies.forEach(depId => {
                        const toUnit = unitsMap.get(depId);
                        const toCenter = getUnitCenter(toUnit.id);

                        if (!toCenter) return;

                        // Determine connection points for cleaner arrows (e.g., right side to left side)
                        let x1 = fromCenter.x;
                        let y1 = fromCenter.y;
                        let x2 = toCenter.x;
                        let y2 = toCenter.y;

                        // Adjust start/end points to connect to unit edges, not just centers
                        // This is a simplified logic and might need more refinement for complex overlaps
                        const unitWidth = document.querySelector('.unit').offsetWidth;
                        const unitHeight = document.querySelector('.unit').offsetHeight;

                        // Try to connect from the side closest to the target
                        // This logic can be improved for more precise connections based on relative positions
                        if (Math.abs(x1 - x2) > Math.abs(y1 - y2)) { // More horizontal movement
                            if (x1 < x2) { x1 += unitWidth / 2; x2 -= unitWidth / 2; }
                            else { x1 -= unitWidth / 2; x2 += unitWidth / 2; }
                        } else { // More vertical movement
                            if (y1 < y2) { y1 += unitHeight / 2; y2 -= unitHeight / 2; }
                            else { y1 -= unitHeight / 2; y2 += unitHeight / 2; }
                        }


                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x1);
                        line.setAttribute('y1', y1);
                        line.setAttribute('x2', x2);
                        line.setAttribute('y2', y2);

                        // Check if the path is "approved" (i.e., both units in the dependency chain are approved)
                        const isPathApproved = isUnitApproved(fromUnit.id) && isUnitApproved(toUnit.id);
                        line.classList.add('arrow-line');
                        if (isPathApproved) {
                            line.classList.add('approved-path');
                            line.setAttribute('marker-end', 'url(#arrowhead-approved)');
                        } else {
                            line.setAttribute('marker-end', 'url(#arrowhead)');
                        }

                        arrowSvg.appendChild(line);
                    });
                });
            }

            // Initial rendering and state update
            renderUnits();
            updateUnitStates();
            // Redraw arrows on window resize to ensure correct positioning
            window.addEventListener('resize', () => {
                drawArrows();
                // Re-calculate unit positions if they are percentage based and wrapper size changes
                // For fixed pixel units, only arrow redraw is needed.
            });

            // Clear progress button functionality
            clearProgressBtn.addEventListener('click', () => {
                if (confirm('¬øEst√°s seguro de que quieres borrar todo el progreso? Esta acci√≥n no se puede deshacer.')) {
                    localStorage.removeItem('approvedUnits');
                    approvedUnits = [];
                    updateUnitStates();
                    alert('Progreso borrado exitosamente.');
                }
            });

            // Suggest next steps button functionality
            suggestNextStepsBtn.addEventListener('click', suggestNextSteps);
        });
    </script>
</body>
</html>
