<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Curricular de Ingenier√≠a</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to override or enhance Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1 {
            @apply text-3xl font-extrabold text-gray-800 mb-6 text-center;
        }

        .curriculum-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px; /* Max width for the entire map */
            min-height: 2000px; /* Adjusted height for new layout */
            margin-top: 20px;
            margin-bottom: 50px;
        }

        .unit {
            position: absolute;
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.2;
            width: 130px; /* Slightly wider for longer names */
            height: 70px; /* Slightly taller for more content */
            z-index: 10;
        }

        .unit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .unit.approved {
            background-color: #d1fae5; /* Green-100 */
            border-color: #34d399; /* Green-400 */
            color: #065f46; /* Green-800 */
        }

        .unit.locked {
            background-color: #f3f4f6; /* Gray-100 */
            border-color: #cbd5e1; /* Gray-300 */
            color: #6b7280; /* Gray-500 */
            cursor: not-allowed;
        }

        .unit-title {
            font-weight: 600; /* semibold */
            margin-bottom: 0.25rem;
        }

        .unit-status {
            font-size: 0.8rem;
            color: #9ca3af; /* Gray-400 */
        }

        .unit.approved .unit-status {
            color: #065f46; /* Green-800 */
        }

        .unit.locked .unit-status {
            color: #9ca3af; /* Gray-400 */
        }

        .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.3rem 0.6rem;
            position: absolute;
            z-index: 20; /* Above units */
            bottom: 110%; /* Position above the unit */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .unit.locked:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .clear-progress-btn {
            @apply bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300;
        }

        /* Styles for sections (An√°lisis, √Ålgebra, Geometr√≠a, Aritm√©tica) */
        .section-label {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            z-index: 15; /* Above units */
            background-color: #f0f2f5; /* Match body background */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        /* Specific positioning for section labels based on the new layout */
        #analisis-label { top: 0%; left: 10%; color: #ef4444; /* Red */ }
        #algebra-label { top: 0%; left: 40%; color: #3b82f6; /* Blue */ }
        #geometria-label { top: 0%; left: 70%; color: #22c55e; /* Green */ }
        #aritmetica-label { top: 60%; left: 10%; color: #6b7280; /* Gray */ } /* Moved lower to group Aritmetica */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .unit {
                width: 90px; /* Smaller width for mobile */
                height: 55px; /* Smaller height for mobile */
                font-size: 0.7rem;
                padding: 0.4rem 0.6rem;
            }
            .unit-title {
                font-size: 0.8rem;
            }
            .unit-status {
                font-size: 0.6rem;
            }
            .section-label {
                font-size: 1rem;
            }
            .curriculum-wrapper {
                min-height: 2500px; /* Increase height for smaller screens */
            }
        }
    </style>
</head>
<body>
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Gu√≠a Propuesta para Estudiar Temas de Matem√°tica para Carreras de Ingenier√≠a</h1>
    <div class="flex flex-wrap justify-center gap-4 mb-6">
        <button id="clearProgressBtn" class="clear-progress-btn">Borrar Progreso</button>
        <button id="suggestNextStepsBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">
            ‚ú® Sugerir Siguientes Pasos
        </button>
    </div>


    <div id="curriculumWrapper" class="curriculum-wrapper">
        <!-- Section Labels -->
        <div id="analisis-label" class="section-label">AN√ÅLISIS</div>
        <div id="algebra-label" class="section-label">√ÅLGEBRA</div>
        <div id="geometria-label" class="section-label">GEOMETR√çA</div>
        <div id="aritmetica-label" class="section-label">ARITM√âTICA</div>

        <!-- Units will be injected here by JavaScript -->
    </div>

    <!-- LLM Modal Structure -->
    <div id="llmModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="llmModalContent" class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-11/12 max-h-[80vh] overflow-y-auto relative">
            <h3 class="text-xl font-bold mb-4"></h3>
            <div id="llmModalBody" class="text-gray-700 mb-4"></div>
            <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal()">
                &times;
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const curriculumWrapper = document.getElementById('curriculumWrapper');
            const clearProgressBtn = document.getElementById('clearProgressBtn');
            const suggestNextStepsBtn = document.getElementById('suggestNextStepsBtn');

            // Modal elements
            const llmModalOverlay = document.getElementById('llmModalOverlay');
            const llmModalContent = document.getElementById('llmModalContent');
            const llmModalTitle = llmModalContent.querySelector('h3');
            const llmModalBody = document.getElementById('llmModalBody');

            let approvedUnits = JSON.parse(localStorage.getItem('approvedUnits')) || [];

            // Define all units with their properties (id, name, dependencies, position, color hint for sections)
            // Positions (x, y) are relative percentages within the curriculumWrapper
            // Units are now grouped by section and ordered top-to-bottom within their columns
            const unitsData = [
                // ARITM√âTICA (Column 1, starting lower)
                { id: 'empezar_aqui', name: 'Empezar Aqu√≠', dependencies: [], x: 15, y: 65, section: 'aritmetica' },
                { id: 'introduccion_aritmetica', name: 'Introducci√≥n a la Aritm√©tica', dependencies: ['empezar_aqui'], x: 15, y: 70, section: 'aritmetica' },
                { id: 'conjuntos', name: 'Conjuntos', dependencies: ['introduccion_aritmetica'], x: 5, y: 75, section: 'aritmetica' },
                { id: 'numeros_reales', name: 'N√∫meros Reales', dependencies: ['introduccion_aritmetica'], x: 15, y: 75, section: 'aritmetica' },
                { id: 'valor_absoluto_aritmetica', name: 'Valor Absoluto', dependencies: ['numeros_reales'], x: 5, y: 80, section: 'aritmetica' },
                { id: 'operaciones_basicas', name: 'Operaciones B√°sicas', dependencies: ['introduccion_aritmetica'], x: 25, y: 75, section: 'aritmetica' },
                { id: 'razones_proporciones', name: 'Razones y Proporciones', dependencies: ['operaciones_basicas'], x: 25, y: 80, section: 'aritmetica' },
                { id: 'porcentajes', name: 'Porcentajes', dependencies: ['razones_proporciones'], x: 25, y: 85, section: 'aritmetica' },
                { id: 'potenciacion_radicacion', name: 'Potenciaci√≥n y Radicaci√≥n', dependencies: ['operaciones_basicas'], x: 15, y: 85, section: 'aritmetica' },
                { id: 'logaritmos', name: 'Logaritmos', dependencies: ['potenciacion_radicacion'], x: 15, y: 90, section: 'aritmetica' },

                // √ÅLGEBRA (Column 2)
                { id: 'introduccion_algebra', name: 'Introducci√≥n al √Ålgebra', dependencies: ['numeros_reales', 'operaciones_basicas'], x: 45, y: 5, section: 'algebra' },
                { id: 'expresiones_algebraicas', name: 'Expresiones Algebraicas', dependencies: ['introduccion_algebra'], x: 45, y: 10, section: 'algebra' },
                { id: 'productos_notables', name: 'Productos Notables', dependencies: ['expresiones_algebraicas'], x: 45, y: 15, section: 'algebra' },
                { id: 'factorizacion', name: 'Factorizaci√≥n', dependencies: ['productos_notables'], x: 45, y: 20, section: 'algebra' },
                { id: 'fracciones_algebraicas', name: 'Fracciones Algebraicas', dependencies: ['factorizacion'], x: 45, y: 25, section: 'algebra' },
                { id: 'ecuaciones_lineales', name: 'Ecuaciones Lineales', dependencies: ['fracciones_algebraicas'], x: 45, y: 30, section: 'algebra' },
                { id: 'inecuaciones', name: 'Inecuaciones', dependencies: ['ecuaciones_lineales'], x: 30, y: 35, section: 'algebra' },
                { id: 'ecuaciones_cuadraticas', name: 'Ecuaciones Cuadr√°ticas', dependencies: ['ecuaciones_lineales'], x: 60, y: 35, section: 'algebra' },
                { id: 'sistemas_ecuaciones', name: 'Sistemas de Ecuaciones', dependencies: ['ecuaciones_lineales'], x: 75, y: 35, section: 'algebra' },
                { id: 'matrices_determinantes', name: 'Matrices y Determinantes', dependencies: ['sistemas_ecuaciones'], x: 75, y: 40, section: 'algebra' },
                { id: 'vectores', name: 'Vectores', dependencies: ['matrices_determinantes'], x: 75, y: 45, section: 'algebra' },
                { id: 'numeros_complejos', name: 'N√∫meros Complejos', dependencies: ['ecuaciones_cuadraticas'], x: 60, y: 45, section: 'algebra' },

                // AN√ÅLISIS (Column 1)
                { id: 'funciones_analisis', name: 'Funciones (An√°lisis)', dependencies: ['ecuaciones_lineales', 'inecuaciones', 'ecuaciones_cuadraticas', 'logaritmos'], x: 15, y: 5, section: 'analisis' },
                { id: 'limites', name: 'L√≠mites', dependencies: ['funciones_analisis'], x: 15, y: 10, section: 'analisis' },
                { id: 'continuidad', name: 'Continuidad', dependencies: ['limites'], x: 15, y: 15, section: 'analisis' },
                { id: 'derivadas', name: 'Derivadas', dependencies: ['continuidad'], x: 15, y: 20, section: 'analisis' },
                { id: 'aplicaciones_derivada', name: 'Aplicaciones de la Derivada', dependencies: ['derivadas'], x: 15, y: 25, section: 'analisis' },
                { id: 'integrales', name: 'Integrales', dependencies: ['aplicaciones_derivada'], x: 15, y: 30, section: 'analisis' },
                { id: 'aplicaciones_integral', name: 'Aplicaciones de la Integral', dependencies: ['integrales'], x: 15, y: 35, section: 'analisis' },
                { id: 'series_sucesiones', name: 'Series y Sucesiones', dependencies: ['integrales'], x: 30, y: 35, section: 'analisis' },
                { id: 'ecuaciones_diferenciales', name: 'Ecuaciones Diferenciales', dependencies: ['integrales', 'series_sucesiones'], x: 45, y: 35, section: 'analisis' },
                { id: 'funciones_varias_variables', name: 'Funciones de Varias Variables', dependencies: ['derivadas', 'integrales', 'vectores'], x: 15, y: 40, section: 'analisis' },
                { id: 'derivadas_parciales', name: 'Derivadas Parciales', dependencies: ['funciones_varias_variables'], x: 30, y: 40, section: 'analisis' },
                { id: 'integrales_multiples', name: 'Integrales M√∫ltiples', dependencies: ['derivadas_parciales'], x: 45, y: 40, section: 'analisis' },
                { id: 'ecuaciones_diferenciales_parciales', name: 'Ecuaciones Diferenciales Parciales', dependencies: ['ecuaciones_diferenciales', 'integrales_multiples'], x: 60, y: 40, section: 'analisis' },
                { id: 'transformadas_laplace', name: 'Transformadas de Laplace', dependencies: ['integrales', 'ecuaciones_diferenciales'], x: 0, y: 45, section: 'analisis' },
                { id: 'transformadas_fourier', name: 'Transformadas de Fourier', dependencies: ['integrales', 'series_sucesiones'], x: 0, y: 50, section: 'analisis' },

                // GEOMETR√çA (Column 3)
                { id: 'introduccion_geometria', name: 'Introducci√≥n a la Geometr√≠a', dependencies: ['numeros_reales'], x: 90, y: 5, section: 'geometria' },
                { id: 'geometria_plana', name: 'Geometr√≠a Plana', dependencies: ['introduccion_geometria'], x: 90, y: 10, section: 'geometria' },
                { id: 'trigonometria', name: 'Trigonometr√≠a', dependencies: ['geometria_plana'], x: 90, y: 15, section: 'geometria' },
                { id: 'geometria_espacial', name: 'Geometr√≠a Espacial', dependencies: ['geometria_plana'], x: 90, y: 20, section: 'geometria' },
                { id: 'geometria_analitica', name: 'Geometr√≠a Anal√≠tica', dependencies: ['geometria_espacial', 'vectores'], x: 90, y: 25, section: 'geometria' },
                { id: 'conicas', name: 'C√≥nicas', dependencies: ['geometria_analitica'], x: 90, y: 30, section: 'geometria' },
                { id: 'transformaciones_geometricas', name: 'Transformaciones Geom√©tricas', dependencies: ['geometria_analitica'], x: 90, y: 35, section: 'geometria' },
                { id: 'calculo_vectorial', name: 'C√°lculo Vectorial', dependencies: ['vectores', 'derivadas', 'integrales'], x: 75, y: 50, section: 'geometria' },
                { id: 'topologia', name: 'Topolog√≠a', dependencies: ['calculo_vectorial'], x: 90, y: 50, section: 'geometria' },

                // Connections between sections / Other (Positioned to fit logically)
                { id: 'matematicas_discretas', name: 'Matem√°ticas Discretas', dependencies: ['logaritmos', 'productos_notables', 'conjuntos'], x: 45, y: 90, section: 'algebra' },
                { id: 'probabilidad_estadistica', name: 'Probabilidad y Estad√≠stica', dependencies: ['logaritmos', 'sistemas_ecuaciones', 'conjuntos'], x: 75, y: 90, section: 'algebra' },
            ];

            // Map unit IDs to their data objects for easy lookup
            const unitsMap = new Map(unitsData.map(unit => [unit.id, unit]));

            function saveProgress() {
                localStorage.setItem('approvedUnits', JSON.stringify(approvedUnits));
            }

            function isUnitApproved(unitId) {
                return approvedUnits.includes(unitId);
            }

            function getMissingDependencies(unitId) {
                const unit = unitsMap.get(unitId);
                if (!unit) return [];
                return unit.dependencies.filter(depId => !isUnitApproved(depId));
            }

            function openModal(title, content) {
                llmModalTitle.textContent = title;
                llmModalBody.innerHTML = content;
                llmModalOverlay.classList.remove('hidden');
            }

            function closeModal() {
                llmModalOverlay.classList.add('hidden');
            }

            // Make closeModal globally accessible (for the button in the modal)
            window.closeModal = closeModal;

            async function generateSummary(unitId) {
                const unitName = unitsMap.get(unitId)?.name || unitId;
                openModal(`Generando Resumen para "${unitName}"...`, '<p class="text-center">Cargando... ‚ú®</p>');

                try {
                    const prompt = `Genera un resumen conciso y educativo sobre el tema "${unitName}" de matem√°ticas para estudiantes de ingenier√≠a. Enf√≥cate en los conceptos clave y su relevancia.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmModalBody.innerHTML = `<p>${text}</p>`;
                        llmModalTitle.textContent = `Resumen de "${unitName}"`;
                    } else {
                        llmModalBody.innerHTML = '<p class="text-red-500">Error: No se pudo generar el resumen. Int√©ntalo de nuevo.</p>';
                    }
                } catch (error) {
                    console.error('Error al llamar a la API de Gemini:', error);
                    llmModalBody.innerHTML = '<p class="text-red-500">Error de conexi√≥n o del servidor. Int√©ntalo de nuevo.</p>';
                }
            }

            async function suggestNextSteps() {
                openModal('Generando Sugerencias de Estudio...', '<p class="text-center">Cargando... ‚ú®</p>');

                try {
                    const approvedUnitNames = approvedUnits.map(id => unitsMap.get(id)?.name).filter(Boolean);
                    let prompt;
                    if (approvedUnitNames.length > 0) {
                        prompt = `Basado en los siguientes temas de matem√°ticas ya aprobados por un estudiante de ingenier√≠a: ${approvedUnitNames.join(', ')}. Sugiere los 3 a 5 siguientes pasos l√≥gicos en su ruta de estudio. S√© conciso y menciona por qu√© cada sugerencia es relevante.`;
                    } else {
                        prompt = `Un estudiante de ingenier√≠a acaba de empezar su malla curricular de matem√°ticas. Sugiere los 3 a 5 primeros temas fundamentales para comenzar, explicando brevemente por qu√© son importantes.`;
                    }

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmModalBody.innerHTML = `<p>${text}</p>`;
                        llmModalTitle.textContent = `Sugerencias de Estudio ‚ú®`;
                    } else {
                        llmModalBody.innerHTML = '<p class="text-red-500">Error: No se pudieron generar sugerencias. Int√©ntalo de nuevo.</p>';
                    }
                } catch (error) {
                    console.error('Error al llamar a la API de Gemini:', error);
                    llmModalBody.innerHTML = '<p class="text-red-500">Error de conexi√≥n o del servidor. Int√©ntalo de nuevo.</p>';
                }
            }


            function updateUnitStates() {
                document.querySelectorAll('.unit').forEach(unitElement => {
                    const unitId = unitElement.dataset.id;
                    const missingDeps = getMissingDependencies(unitId);
                    const tooltipSpan = unitElement.querySelector('.tooltip');
                    const summaryBtn = unitElement.querySelector('.generate-summary-btn');

                    if (isUnitApproved(unitId)) {
                        unitElement.classList.add('approved');
                        unitElement.classList.remove('locked');
                        unitElement.querySelector('.unit-status').textContent = 'Aprobado ‚úÖ';
                        if (tooltipSpan) tooltipSpan.textContent = ''; // Clear tooltip for approved
                        if (summaryBtn) summaryBtn.classList.remove('hidden'); // Show summary button
                    } else if (missingDeps.length === 0) {
                        unitElement.classList.remove('locked');
                        unitElement.classList.remove('approved');
                        unitElement.querySelector('.unit-status').textContent = 'Click para aprobar';
                        unitElement.style.cursor = 'pointer';
                        if (tooltipSpan) tooltipSpan.textContent = ''; // Clear tooltip for unlockable
                        if (summaryBtn) summaryBtn.classList.add('hidden'); // Hide summary button
                    } else {
                        unitElement.classList.add('locked');
                        unitElement.classList.remove('approved');
                        unitElement.querySelector('.unit-status').textContent = 'Bloqueado üîí';
                        unitElement.style.cursor = 'not-allowed';
                        if (tooltipSpan) {
                            const missingNames = missingDeps.map(depId => unitsMap.get(depId)?.name || depId).join(', ');
                            tooltipSpan.textContent = `Falta(n): ${missingNames}`;
                        }
                        if (summaryBtn) summaryBtn.classList.add('hidden'); // Hide summary button
                    }
                });
            }

            function handleUnitClick(event) {
                const unitElement = event.currentTarget;
                const unitId = unitElement.dataset.id;

                // Check if the click originated from the summary button
                if (event.target.classList.contains('generate-summary-btn')) {
                    // This click is handled by the summary button's own listener
                    return;
                }

                if (unitElement.classList.contains('locked')) {
                    // Unit is locked, do nothing (tooltip will show)
                    return;
                }

                if (isUnitApproved(unitId)) {
                    // If already approved, unapprove it (toggle functionality)
                    approvedUnits = approvedUnits.filter(id => id !== unitId);
                } else {
                    // If not approved and dependencies are met, approve it
                    approvedUnits.push(unitId);
                }
                saveProgress();
                updateUnitStates();
            }

            function renderUnits() {
                unitsData.forEach(unit => {
                    const unitElement = document.createElement('div');
                    unitElement.classList.add('unit');
                    unitElement.dataset.id = unit.id;
                    unitElement.style.left = `${unit.x}%`;
                    unitElement.style.top = `${unit.y}%`;

                    unitElement.innerHTML = `
                        <div class="unit-title">${unit.name}</div>
                        <div class="unit-status"></div>
                        <span class="tooltip"></span>
                        <button class="generate-summary-btn mt-2 bg-purple-500 hover:bg-purple-600 text-white text-xs py-1 px-2 rounded-md hidden">
                            ‚ú® Resumen
                        </button>
                    `;
                    unitElement.addEventListener('click', handleUnitClick);
                    curriculumWrapper.appendChild(unitElement);

                    // Add event listener for the summary button
                    const summaryBtn = unitElement.querySelector('.generate-summary-btn');
                    summaryBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent unit click event from firing
                        generateSummary(unit.id);
                    });
                });
            }

            // Initial rendering and state update
            renderUnits();
            updateUnitStates();

            // Clear progress button functionality
            clearProgressBtn.addEventListener('click', () => {
                if (confirm('¬øEst√°s seguro de que quieres borrar todo el progreso? Esta acci√≥n no se puede deshacer.')) {
                    localStorage.removeItem('approvedUnits');
                    approvedUnits = [];
                    updateUnitStates();
                    alert('Progreso borrado exitosamente.');
                }
            });

            // Suggest next steps button functionality
            suggestNextStepsBtn.addEventListener('click', suggestNextSteps);
        });
    </script>
</body>
</html>
